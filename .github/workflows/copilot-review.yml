name: Copilot Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created, deleted]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  copilot-review-check:
    name: Copilot Review Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip for pull_request_review_comment events from non-Copilot users
    if: >-
      ${{ github.event_name != 'pull_request_review_comment' ||
          contains(github.event.comment.user.login, 'copilot') }}
    steps:
      - name: Determine PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR info for workflow_dispatch
        id: pr_info
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }})
          echo "head_sha=$(echo "$pr_data" | jq -r '.head.sha')" >> $GITHUB_OUTPUT

      - name: Check for admin bypass
        id: bypass
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          labels=$(gh api repos/${{ github.repository }}/issues/${{ steps.pr.outputs.number }}/labels --jq '.[].name')
          if echo "$labels" | grep -q "skip-copilot-review"; then
            echo "Admin bypass label found"
            echo "bypass=true" >> $GITHUB_OUTPUT
          else
            echo "bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Get Copilot review status
        if: steps.bypass.outputs.bypass != 'true'
        id: copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          # Use workflow_dispatch SHA if available, otherwise use PR event SHA
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            HEAD_SHA=${{ steps.pr_info.outputs.head_sha }}
          else
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
          fi

          echo "Checking Copilot review for PR #$PR_NUMBER (commit: $HEAD_SHA)"

          # Get all reviews on the PR
          reviews=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews)

          # Find Copilot's most recent review (handle various Copilot user names)
          copilot_review=$(echo "$reviews" | jq -r '
            [.[] | select(
              .user.login == "copilot-pull-request-reviewer[bot]" or
              .user.login == "copilot-pull-request-reviewer" or
              .user.login == "github-copilot[bot]" or
              (.user.type == "Bot" and (.user.login | contains("copilot")))
            )]
            | sort_by(.submitted_at)
            | last
          ')

          if [ "$copilot_review" == "null" ] || [ -z "$copilot_review" ]; then
            echo "No Copilot review found"
            echo "reviewed=false" >> $GITHUB_OUTPUT
            echo "has_unresolved=false" >> $GITHUB_OUTPUT
            echo "unresolved_count=0" >> $GITHUB_OUTPUT
            echo "total_count=0" >> $GITHUB_OUTPUT
          else
            echo "Copilot review found"
            echo "reviewed=true" >> $GITHUB_OUTPUT

            # Use GraphQL to get review threads with resolution status
            # This lets us check if Copilot comments have been resolved
            OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

            threads_response=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    reviewThreads(first: 100) {
                      nodes {
                        isResolved
                        comments(first: 1) {
                          nodes {
                            author {
                              login
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            ' -f owner="$OWNER" -f repo="$REPO" -F number="$PR_NUMBER")

            # Count Copilot threads (total and unresolved)
            copilot_threads=$(echo "$threads_response" | jq '[
              .data.repository.pullRequest.reviewThreads.nodes[] |
              select(.comments.nodes[0].author.login |
                test("copilot"; "i")
              )
            ]')

            total_count=$(echo "$copilot_threads" | jq 'length')
            unresolved_count=$(echo "$copilot_threads" | jq '[.[] | select(.isResolved == false)] | length')

            echo "Copilot threads: $total_count total, $unresolved_count unresolved"
            echo "total_count=$total_count" >> $GITHUB_OUTPUT
            echo "unresolved_count=$unresolved_count" >> $GITHUB_OUTPUT

            if [ "$unresolved_count" -gt 0 ]; then
              echo "has_unresolved=true" >> $GITHUB_OUTPUT
            else
              echo "has_unresolved=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Manage labels
        if: steps.bypass.outputs.bypass != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          REVIEWED="${{ steps.copilot.outputs.reviewed }}"

          # Get current labels
          current_labels=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/labels --jq '.[].name')
          has_needs_review_label=$(echo "$current_labels" | grep -c "needs copilot review" || true)

          if [ "$REVIEWED" != "true" ]; then
            # Add label if not present (Copilot hasn't reviewed yet)
            if [ "$has_needs_review_label" -eq 0 ]; then
              echo "Adding 'needs copilot review' label"
              gh api repos/${{ github.repository }}/issues/$PR_NUMBER/labels \
                --method POST \
                -f "labels[]=needs copilot review" || true
            fi
          else
            # Remove label if present (Copilot has reviewed)
            if [ "$has_needs_review_label" -gt 0 ]; then
              echo "Removing 'needs copilot review' label"
              gh api repos/${{ github.repository }}/issues/$PR_NUMBER/labels/needs%20copilot%20review \
                --method DELETE || true
            fi
          fi

      - name: Set status check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use workflow_dispatch SHA if available, otherwise use PR event SHA
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            HEAD_SHA=${{ steps.pr_info.outputs.head_sha }}
          else
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
          fi
          BYPASS="${{ steps.bypass.outputs.bypass }}"
          REVIEWED="${{ steps.copilot.outputs.reviewed }}"
          HAS_UNRESOLVED="${{ steps.copilot.outputs.has_unresolved }}"
          UNRESOLVED_COUNT="${{ steps.copilot.outputs.unresolved_count }}"
          TOTAL_COUNT="${{ steps.copilot.outputs.total_count }}"

          if [ "$BYPASS" == "true" ]; then
            state="success"
            description="Copilot review bypassed by admin"
          elif [ "$REVIEWED" != "true" ]; then
            state="pending"
            description="Waiting for Copilot review"
          elif [ "$HAS_UNRESOLVED" == "true" ]; then
            state="failure"
            description="$UNRESOLVED_COUNT unresolved Copilot comment(s) - please resolve"
          elif [ "$TOTAL_COUNT" -gt 0 ]; then
            state="success"
            description="Copilot reviewed - all $TOTAL_COUNT comment(s) resolved"
          else
            state="success"
            description="Copilot review passed - no issues found"
          fi

          echo "Setting status: $state - $description"

          gh api repos/${{ github.repository }}/statuses/$HEAD_SHA \
            -f state="$state" \
            -f context="Copilot Review Status" \
            -f description="$description"

  # Job that sets success status for bot PRs (so they're not blocked)
  copilot-review-bot:
    name: Copilot Review (Bot PR)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: ${{ endsWith(github.actor, '[bot]') }}
    permissions:
      statuses: write
    steps:
      - name: Set success status for bot PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Setting success status for bot PR (author: ${{ github.actor }})"

          gh api repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f state="success" \
            -f context="Copilot Review Status" \
            -f description="Skipped for automated PR"

# Dev Build - Quick single-platform desktop builds for testing
#
# Creates private artifacts (only accessible to repo maintainers) without
# going through the full release pipeline. Use this for testing platform-
# specific issues quickly.
#
# Artifacts are retained for 7 days and are NOT published to any release.

name: "25 Dev: Build Desktop"

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - windows
          - macos-arm64
          - macos-x64
          - linux-x64
          - linux-arm64
      version:
        description: 'Version (must be valid semver, e.g., 0.0.0-dev)'
        required: false
        default: '0.0.0-dev'

permissions:
  contents: read

jobs:
  # =========================================================================
  # Build Frontend (always needed)
  # =========================================================================
  build-frontend:
    runs-on: ${{ vars.RUNNER_PROVIDER == 'namespace' && 'ubuntu-2204-x64-4x16' || 'ubuntu-latest' }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_DESKTOP_BUILD: 'true'
          VITE_APP_VERSION: ${{ inputs.version }}

      - name: Upload frontend artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # =========================================================================
  # Build Backend - Windows
  # =========================================================================
  # NOTE: Windows builds always use GitHub runners (no Namespace Windows support)
  # PyInstaller cannot cross-compile - it must build on the target OS
  build-backend-win:
    if: inputs.platform == 'windows'
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --require-hashes -r requirements/base.txt
          pip install --no-deps -r requirements/vcs.txt
          pip install pyinstaller==6.11.1 pyinstaller-hooks-contrib==2025.11

      - name: Build backend with PyInstaller
        working-directory: desktop
        run: node scripts/build-backend.js

      - name: Upload backend artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: backend-win
          path: desktop/pyinstaller/dist/eclosion-backend
          retention-days: 1

  # =========================================================================
  # Build Backend - macOS
  # =========================================================================
  build-backend-mac:
    if: inputs.platform == 'macos-arm64' || inputs.platform == 'macos-x64'
    runs-on: ${{ vars.RUNNER_PROVIDER == 'namespace' && (inputs.platform == 'macos-arm64' && 'macos-sonoma-arm64' || 'macos-sonoma-arm64') || (inputs.platform == 'macos-arm64' && 'macos-15' || 'macos-14-xlarge') }}
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --require-hashes -r requirements/build.txt
          pip install --require-hashes -r requirements/base.txt
          pip install --no-deps -r requirements/vcs.txt

      - name: Build backend with PyInstaller
        working-directory: desktop
        run: node scripts/build-backend.js

      - name: Upload backend artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: backend-mac
          path: desktop/pyinstaller/dist/eclosion-backend
          retention-days: 1

  # =========================================================================
  # Build Backend - Linux
  # =========================================================================
  build-backend-linux:
    if: inputs.platform == 'linux-x64' || inputs.platform == 'linux-arm64'
    runs-on: ${{ vars.RUNNER_PROVIDER == 'namespace' && (inputs.platform == 'linux-arm64' && 'ubuntu-2404-arm64-4x16' || 'ubuntu-2204-x64-4x16') || (inputs.platform == 'linux-arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') }}
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --require-hashes -r requirements/build.txt
          pip install --require-hashes -r requirements/base.txt
          pip install --no-deps -r requirements/vcs.txt

      - name: Build backend with PyInstaller
        working-directory: desktop
        run: node scripts/build-backend.js

      - name: Upload backend artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: backend-linux
          path: desktop/pyinstaller/dist/eclosion-backend
          retention-days: 1

  # =========================================================================
  # Package - Windows
  # =========================================================================
  # NOTE: Windows packaging always uses GitHub runners (no Namespace Windows support)
  package-win:
    if: inputs.platform == 'windows'
    needs: [build-frontend, build-backend-win]
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: desktop/package-lock.json

      - name: Download frontend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: backend-win
          path: desktop/pyinstaller/dist/eclosion-backend

      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci

      - name: Set version in package.json
        working-directory: desktop
        shell: pwsh
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          $pkg.version = "${{ inputs.version }}"
          $pkg | ConvertTo-Json -Depth 10 | Set-Content package.json

      - name: Build Electron main process
        working-directory: desktop
        run: npm run build:main
        env:
          ECLOSION_VERSION: ${{ inputs.version }}
          RELEASE_CHANNEL: beta

      - name: Package for Windows
        working-directory: desktop
        shell: pwsh
        run: npx electron-builder --win --publish never --config electron-builder.beta.yml

      - name: Upload Windows artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: dev-build-windows-${{ github.run_number }}
          path: desktop/release/*.exe
          retention-days: 7

      - name: Summary
        shell: pwsh
        run: |
          echo "## Dev Build Complete - Windows" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $env:GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $env:GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "Download the artifact from the **Artifacts** section below." >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "⚠️ This is a dev build - not signed, not for distribution." >> $env:GITHUB_STEP_SUMMARY

  # =========================================================================
  # Package - macOS
  # =========================================================================
  package-mac:
    if: inputs.platform == 'macos-arm64' || inputs.platform == 'macos-x64'
    needs: [build-frontend, build-backend-mac]
    runs-on: ${{ vars.RUNNER_PROVIDER == 'namespace' && (inputs.platform == 'macos-arm64' && 'macos-sonoma-arm64' || 'macos-sonoma-arm64') || (inputs.platform == 'macos-arm64' && 'macos-15' || 'macos-14-xlarge') }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: desktop/package-lock.json

      - name: Download frontend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: backend-mac
          path: desktop/pyinstaller/dist/eclosion-backend

      - name: Prepare backend
        run: chmod +x desktop/pyinstaller/dist/eclosion-backend/eclosion-backend

      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci

      - name: Set version in package.json
        working-directory: desktop
        run: |
          jq --arg v "${{ inputs.version }}" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build Electron main process
        working-directory: desktop
        run: npm run build:main
        env:
          ECLOSION_VERSION: ${{ inputs.version }}
          RELEASE_CHANNEL: beta

      - name: Package for macOS (unsigned)
        working-directory: desktop
        run: |
          ARCH="${{ inputs.platform == 'macos-arm64' && 'arm64' || 'x64' }}"
          npx electron-builder --mac --$ARCH --publish never --config electron-builder.beta.yml

      - name: Upload macOS artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: dev-build-${{ inputs.platform }}-${{ github.run_number }}
          path: |
            desktop/release/*.dmg
            desktop/release/*.zip
          retention-days: 7

      - name: Summary
        run: |
          echo "## Dev Build Complete - macOS (${{ inputs.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact from the **Artifacts** section below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ This is a dev build - unsigned, not notarized, not for distribution." >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Package - Linux
  # =========================================================================
  package-linux:
    if: inputs.platform == 'linux-x64' || inputs.platform == 'linux-arm64'
    needs: [build-frontend, build-backend-linux]
    runs-on: ${{ vars.RUNNER_PROVIDER == 'namespace' && (inputs.platform == 'linux-arm64' && 'ubuntu-2404-arm64-4x16' || 'ubuntu-2204-x64-4x16') || (inputs.platform == 'linux-arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: desktop/package-lock.json

      - name: Download frontend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: backend-linux
          path: desktop/pyinstaller/dist/eclosion-backend

      - name: Make backend executable
        run: chmod +x desktop/pyinstaller/dist/eclosion-backend/eclosion-backend

      - name: Install native packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci

      - name: Set version in package.json
        working-directory: desktop
        run: |
          jq --arg v "${{ inputs.version }}" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build Electron main process
        working-directory: desktop
        run: npm run build:main
        env:
          ECLOSION_VERSION: ${{ inputs.version }}
          RELEASE_CHANNEL: beta

      - name: Package for Linux
        working-directory: desktop
        env:
          USE_SYSTEM_FPM: 'true'
        run: |
          ARCH="${{ inputs.platform == 'linux-arm64' && 'arm64' || 'x64' }}"
          npx electron-builder --linux --$ARCH --publish never --config electron-builder.beta.yml

      - name: Upload Linux artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: dev-build-${{ inputs.platform }}-${{ github.run_number }}
          path: |
            desktop/release/*.AppImage
            desktop/release/*.deb
            desktop/release/*.rpm
          retention-days: 7

      - name: Summary
        run: |
          echo "## Dev Build Complete - Linux (${{ inputs.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact from the **Artifacts** section below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ This is a dev build - not for distribution." >> $GITHUB_STEP_SUMMARY

# Create Beta Release
#
# Manually triggered workflow to create a beta pre-release from the main branch.
# Beta versions use the format: v{current}-beta.{YYYYMMDD}.{sequence}
#
# VERSION SOURCE OF TRUTH: frontend/package.json
# Beta versions are calculated from this file. The build-desktop workflow
# sets desktop/package.json at build time (not committed for beta releases).
#
# Flow:
#   1. Validate main branch
#   2. Calculate version
#   3. Create draft pre-release
#   4. Run release pipeline (security → build all → validate → publish)
#   5. Finalize pre-release (mark non-draft)
#
# If any step fails, the release remains in draft state and nothing is published.

name: "20 Release: Beta"

on:
  workflow_dispatch:
    inputs:
      release_context:
        description: "Optional context to guide AI summary (e.g., 'This release renames Wishlists to Stashes')"
        required: false
        type: string

# Only one beta release at a time - cancel any in-progress run
concurrency:
  group: release-beta
  cancel-in-progress: true

permissions: {}

jobs:
  # ===========================================================================
  # PREPARATION
  # ===========================================================================
  check-branch:
    name: Validate Branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}
    steps:
      - name: Require main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::This workflow can ONLY run from the main branch."
            echo ""
            echo "Current branch: ${{ github.ref }}"
            echo "Required branch: refs/heads/main"
            echo ""
            echo "To create a beta release:"
            echo "1. Go to Actions → Release: Create Beta"
            echo "2. Click 'Run workflow'"
            echo "3. Select 'main' from the branch dropdown"
            exit 1
          fi
          echo "✓ Running on main branch"

  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
    steps:
      - name: Check CI and Security workflow status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.sha }}"
          REPO="${{ github.repository }}"
          MAX_WAIT=600  # 10 minutes
          POLL_INTERVAL=30

          # Function to check a workflow's status
          check_workflow() {
            local workflow_file=$1
            local workflow_name=$2
            local waited=0

            echo "Checking $workflow_name status for commit: $SHA"

            while true; do
              RUN_INFO=$(gh api "repos/$REPO/actions/workflows/$workflow_file/runs?head_sha=$SHA&per_page=1" --jq '.workflow_runs[0] | {status: .status, conclusion: .conclusion, id: .id}' 2>/dev/null || echo "{}")

              STATUS=$(echo "$RUN_INFO" | jq -r '.status // "not_found"')
              CONCLUSION=$(echo "$RUN_INFO" | jq -r '.conclusion // "null"')
              RUN_ID=$(echo "$RUN_INFO" | jq -r '.id // "null"')

              echo "[$workflow_name] Run ID: $RUN_ID, Status: $STATUS, Conclusion: $CONCLUSION"

              if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" = "success" ]; then
                echo "✅ $workflow_name passed"
                echo "✅ $workflow_name **success** for \`$SHA\` (Run ID: $RUN_ID)" >> $GITHUB_STEP_SUMMARY
                return 0
              elif [ "$STATUS" = "completed" ] && [ "$CONCLUSION" != "success" ]; then
                echo "::error::$workflow_name failed (conclusion: $CONCLUSION). Fix before creating a release."
                echo "❌ $workflow_name **$CONCLUSION** for \`$SHA\`" >> $GITHUB_STEP_SUMMARY
                return 1
              elif [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
                if [ $waited -ge $MAX_WAIT ]; then
                  echo "::error::$workflow_name still running after ${MAX_WAIT}s. Aborting release."
                  echo "⏳ $workflow_name **$STATUS** - timed out after ${MAX_WAIT}s" >> $GITHUB_STEP_SUMMARY
                  return 1
                fi
                echo "⏳ $workflow_name is $STATUS, waiting ${POLL_INTERVAL}s... (${waited}s/${MAX_WAIT}s)"
                sleep $POLL_INTERVAL
                waited=$((waited + POLL_INTERVAL))
              else
                echo "::error::No $workflow_name run found for this commit."
                echo "❌ $workflow_name **not found** for \`$SHA\`" >> $GITHUB_STEP_SUMMARY
                return 1
              fi
            done
          }

          echo "### Workflow Verification" >> $GITHUB_STEP_SUMMARY

          # Check both workflows
          check_workflow "01-ci.yml" "CI" || exit 1
          check_workflow "10-security.yml" "Security" || exit 1

          echo ""
          echo "✅ All required workflows passed!"

  calculate-version:
    name: Calculate Version
    needs: [check-branch, verify-ci]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Calculate beta version
        id: version
        run: |
          BASE=$(node -p "require('./frontend/package.json').version")
          DATE=$(date +%Y%m%d)

          git fetch --tags
          EXISTING=$(git tag -l "v${BASE}-beta.${DATE}.*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))

          VERSION="${BASE}-beta.${DATE}.${SEQ}"
          TAG="v${VERSION}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "### Beta Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** $TAG" >> $GITHUB_STEP_SUMMARY

  create-draft-release:
    name: Create Draft Release
    needs: [calculate-version]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/release-notes-updater/package-lock.json

      - name: Install dependencies
        working-directory: scripts/release-notes-updater
        run: npm ci

      - name: Generate release notes
        env:
          MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use gh release to find actual published stable releases (not orphan tags)
          LAST_STABLE=$(gh release list --exclude-pre-releases --exclude-drafts --limit 1 --json tagName --jq '.[0].tagName')
          NEW_TAG="${{ needs.calculate-version.outputs.tag }}"

          if [ -z "$LAST_STABLE" ]; then
            LAST_STABLE=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating notes from $LAST_STABLE to HEAD (tag: $NEW_TAG)"

          # Generate technical notes only (AI summary added after pipeline succeeds)
          npx tsx scripts/release-notes-updater/generate-notes.ts \
            --from "$LAST_STABLE" \
            --to HEAD \
            --repo-url "https://github.com/${{ github.repository }}" \
            --beta \
            --polish \
            > /tmp/release-notes.md

      - name: Clean up any existing draft with same tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"
          # Check if a draft release with this tag already exists (from a failed previous run)
          EXISTING_DRAFT=$(gh release view "$TAG" --json isDraft --jq '.isDraft' 2>/dev/null || echo "not_found")
          if [ "$EXISTING_DRAFT" = "true" ]; then
            echo "Found existing draft release $TAG from a previous failed run - deleting it"
            gh release delete "$TAG" --yes --cleanup-tag || true
          fi

      - name: Create draft pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.calculate-version.outputs.tag }} \
            --target main \
            --prerelease \
            --draft \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md

          echo "### Draft Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Created draft pre-release: ${{ needs.calculate-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # RUN RELEASE PIPELINE
  # ===========================================================================
  release-pipeline:
    name: Release Pipeline
    needs: [calculate-version, create-draft-release]
    permissions:
      contents: write
      packages: write
      deployments: write
      id-token: write  # Required for Sigstore keyless container signing
    uses: ./.github/workflows/22-release-pipeline.yml
    with:
      release_type: beta
      version: ${{ needs.calculate-version.outputs.version }}
      tag: ${{ needs.calculate-version.outputs.tag }}
      skip_docker: true
      skip_screenshots: true
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  # ===========================================================================
  # FINALIZE
  # ===========================================================================

  # Add AI summary to draft release (can be reviewed before publishing)
  add-ai-summary:
    name: Add AI Summary
    needs: [calculate-version, release-pipeline]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/release-notes-updater/package-lock.json

      - name: Install dependencies
        working-directory: scripts/release-notes-updater
        run: npm ci

      - name: Add AI summary to release
        working-directory: scripts/release-notes-updater
        env:
          MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"
          CONTEXT_FLAG=""
          if [ -n "${{ inputs.release_context }}" ]; then
            CONTEXT_FLAG="--context \"${{ inputs.release_context }}\""
          fi

          echo "Adding AI summary to draft beta release $TAG..."
          npx tsx index.ts --tag "$TAG" $CONTEXT_FLAG

          echo "### AI Summary Added" >> $GITHUB_STEP_SUMMARY
          echo "Added user-friendly summary to draft release **$TAG**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Review Draft Release](https://github.com/${{ github.repository }}/releases/tag/$TAG)" >> $GITHUB_STEP_SUMMARY

  publish-release:
    name: Publish Release
    needs: [calculate-version, add-ai-summary]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Mark release as non-draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh release edit ${{ needs.calculate-version.outputs.tag }} --draft=false

          echo "### Beta Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [${{ needs.calculate-version.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.calculate-version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:**" >> $GITHUB_STEP_SUMMARY
          echo "- [beta.eclosion.app](https://beta.eclosion.app)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: \`ghcr.io/${{ github.repository }}:${{ needs.calculate-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # Cleanup draft release if pipeline fails
  cleanup-on-failure:
    name: Cleanup Failed Release
    needs: [calculate-version, release-pipeline]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Delete draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"
          echo "Pipeline failed - cleaning up draft release $TAG"

          # Delete the release (this also deletes the tag)
          gh release delete "$TAG" --yes --cleanup-tag || true

          echo "### Release Failed" >> $GITHUB_STEP_SUMMARY
          echo "Draft release $TAG has been deleted." >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for failure details." >> $GITHUB_STEP_SUMMARY

name: "41 Generate: Docs"

on:
  workflow_dispatch:
    inputs:
      branch:
        required: true
        type: string
        default: 'main'
        description: Branch to commit generated docs to
      force:
        required: false
        type: boolean
        default: false
        description: Force regeneration of all docs, ignoring manifest
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      branch:
        required: true
        type: string
        description: Branch to commit generated docs to
      force:
        required: false
        type: boolean
        default: false
        description: Force regeneration of all docs, ignoring manifest

permissions: read-all

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            scripts/docs-gen/package-lock.json
            frontend/package-lock.json

      - name: Install docs-gen dependencies
        working-directory: scripts/docs-gen
        run: npm ci

      - name: Extract content from source
        id: extract
        working-directory: scripts/docs-gen
        run: npx tsx index.ts extract

      - name: Detect changes
        id: diff
        if: ${{ !inputs.force }}
        working-directory: scripts/docs-gen
        run: npx tsx index.ts diff

      - name: Generate documentation
        if: steps.diff.outputs.has_changes == 'true' || inputs.force
        working-directory: scripts/docs-gen
        env:
          GH_TOKEN: ${{ secrets.MODELS_TOKEN }}
          APP_VERSION: ${{ inputs.version }}
        run: npx tsx index.ts generate ${{ inputs.force && '--force' || '' }}

      - name: Update manifest
        if: steps.diff.outputs.has_changes == 'true' || inputs.force
        working-directory: scripts/docs-gen
        env:
          APP_VERSION: ${{ inputs.version }}
        run: npx tsx index.ts update-manifest

      - name: Commit generated docs
        id: commit
        if: steps.diff.outputs.has_changes == 'true' || inputs.force
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Add generated docs to Docusaurus
          git add docusaurus/docs/
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          VERSION="${{ inputs.version }}"
          if [ -n "$VERSION" ]; then
            git commit -m "docs: auto-generate user guides for v${VERSION}"
          else
            git commit -m "docs: regenerate user guides"
          fi
          git push
          echo "pushed=true" >> $GITHUB_OUTPUT

      - name: No changes summary
        if: steps.diff.outputs.has_changes != 'true' && !inputs.force
        run: echo "No documentation changes detected - skipping generation"

# Deploy to Cloudflare Pages
#
# Builds the frontend in demo mode and deploys to Cloudflare Pages.
# Supports both production (releases) and beta (pre-releases) deployments.
#
# Deployment triggers:
# - Push to develop: Auto-deploys to beta.eclosion.app (no approval needed)
# - Pre-release published: Deploys to beta.eclosion.app (requires approval)
# - Release published: Deploys to eclosion.app (requires approval)
#
# Beta versions are auto-generated as {base-version}-beta.{short_sha}

name: Deploy to Cloudflare

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (production or beta)'
        required: true
        type: string
      version:
        description: 'Version being deployed'
        required: false
        type: string
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true

  # Auto-deploy beta on push to develop
  push:
    branches: [develop]

  # Trigger on pre-release publication for beta deployments
  release:
    types: [prereleased]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'beta'
        type: choice
        options:
          - production
          - beta

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Skip if triggered by bot commit (prevents infinite loop)
    if: github.actor != 'github-actions[bot]'
    # Use environment protection for releases (requires approval)
    # Push to develop skips environment to allow auto-deploy
    environment: ${{ (github.event_name == 'release' && 'beta') || (github.event_name == 'workflow_call' && inputs.environment) || (github.event_name == 'workflow_dispatch' && inputs.environment) || null }}
    permissions:
      contents: write  # Need write to commit version snapshots
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version commits

      - name: Determine environment and version
        id: config
        run: |
          # Determine environment
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            ENV="${{ inputs.environment }}"
            VERSION="${{ inputs.version }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="beta"
            # Generate beta version: {package.json version}-beta.{short_sha}
            BASE_VERSION=$(node -p "require('./frontend/package.json').version")
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VERSION="${BASE_VERSION}-beta.${SHORT_SHA}"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            ENV="beta"
            # Strip 'v' prefix from tag for consistent versioning
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            ENV="${{ inputs.environment || 'beta' }}"
            BASE_VERSION=$(node -p "require('./frontend/package.json').version")
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VERSION="${BASE_VERSION}-beta.${SHORT_SHA}"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$([[ $ENV == 'production' ]] && echo 'main' || echo 'beta')" >> $GITHUB_OUTPUT

          echo "### Deployment Config" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_DEMO_MODE: 'true'
          VITE_APP_VERSION: ${{ steps.config.outputs.version }}
        run: npm run build

      - name: Install Docusaurus dependencies
        working-directory: docusaurus
        run: npm ci

      - name: Create docs version snapshot (beta only)
        if: steps.config.outputs.environment == 'beta'
        working-directory: docusaurus
        env:
          ECLOSION_BETA: 'true'
        run: |
          VERSION="${{ steps.config.outputs.version }}"
          echo "Creating docs version: $VERSION"

          # Create the version snapshot
          npm run version -- "$VERSION"

          echo "Version $VERSION created"

      - name: Cleanup old beta doc versions
        if: steps.config.outputs.environment == 'beta'
        run: |
          KEEP_COUNT=5
          cd docusaurus

          # Get all beta versions from versions.json
          if [ ! -f versions.json ]; then
            echo "No versions.json found"
            exit 0
          fi

          # Extract beta versions (contain 'beta'), sorted newest first
          BETA_VERSIONS=$(jq -r '.[] | select(contains("beta"))' versions.json)
          BETA_COUNT=$(echo "$BETA_VERSIONS" | grep -c . || echo 0)

          echo "Found $BETA_COUNT beta versions"

          if [ "$BETA_COUNT" -le "$KEEP_COUNT" ]; then
            echo "No cleanup needed (keeping $KEEP_COUNT)"
            exit 0
          fi

          # Get versions to delete (skip first KEEP_COUNT)
          TO_DELETE=$(echo "$BETA_VERSIONS" | tail -n +$((KEEP_COUNT + 1)))

          for VERSION in $TO_DELETE; do
            echo "Removing old beta version: $VERSION"

            # Remove from versions.json
            jq --arg v "$VERSION" 'del(.[] | select(. == $v))' versions.json > versions.tmp && mv versions.tmp versions.json

            # Remove versioned docs and sidebars
            rm -rf "versioned_docs/version-$VERSION"
            rm -f "versioned_sidebars/version-$VERSION-sidebars.json"
          done

          echo "Cleanup complete"

      - name: Build Docusaurus
        working-directory: docusaurus
        env:
          ECLOSION_BETA: ${{ steps.config.outputs.environment == 'beta' && 'true' || '' }}
        run: npm run build

      - name: Merge builds
        run: |
          # Copy Docusaurus build contents into frontend/dist
          # Docusaurus already builds to /docs path, so we copy to root
          cp -r docusaurus/build/* frontend/dist/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy frontend/dist --project-name=eclosion --branch=${{ steps.config.outputs.branch }}

      - name: Cleanup old beta deployments
        if: steps.config.outputs.environment == 'beta'
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Keep only the 5 most recent beta deployments
          KEEP_COUNT=5
          PROJECT="eclosion"

          echo "Fetching beta deployments..."
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${PROJECT}/deployments" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          # Get beta deployment IDs (non-production), sorted by created_on desc, skip first KEEP_COUNT
          BETA_IDS=$(echo "$DEPLOYMENTS" | jq -r --arg keep "$KEEP_COUNT" '
            .result
            | map(select(.environment == "preview"))
            | sort_by(.created_on) | reverse
            | .[$keep | tonumber:]
            | .[].id
          ')

          if [ -z "$BETA_IDS" ]; then
            echo "No old beta deployments to clean up"
            exit 0
          fi

          # Delete old deployments
          for ID in $BETA_IDS; do
            echo "Deleting deployment: $ID"
            curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${PROJECT}/deployments/${ID}" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" | jq -r '.success'
          done

          echo "Cleanup complete"

      - name: Commit docs version changes
        if: steps.config.outputs.environment == 'beta' && github.event_name == 'push'
        run: |
          # Check if there are changes to commit
          if git diff --quiet docusaurus/versions.json docusaurus/versioned_docs docusaurus/versioned_sidebars 2>/dev/null; then
            echo "No version changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docusaurus/versions.json docusaurus/versioned_docs docusaurus/versioned_sidebars
          git commit -m "docs: create beta version ${{ steps.config.outputs.version }}"
          git push

# Create Beta Release
#
# Manually triggered workflow to create a beta pre-release from the main branch.
# Beta versions use the format: v{current}-beta.{YYYYMMDD}.{sequence}
#
# VERSION SOURCE OF TRUTH: frontend/package.json
# Beta versions are calculated from this file. The build-desktop workflow
# sets desktop/package.json at build time (not committed for beta releases).
#
# Flow:
#   1. Validate main branch
#   2. Calculate version
#   3. Create draft pre-release
#   4. Run release pipeline (security → build all → validate → publish)
#   5. Finalize pre-release (mark non-draft)
#
# If any step fails, the release remains in draft state and nothing is published.

name: "Release: Create Beta"

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  security-events: write
  deployments: write
  id-token: write  # Required for Sigstore keyless container signing

jobs:
  # ===========================================================================
  # PREPARATION
  # ===========================================================================
  check-branch:
    name: Validate Branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Require main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::This workflow can ONLY run from the main branch."
            echo ""
            echo "Current branch: ${{ github.ref }}"
            echo "Required branch: refs/heads/main"
            echo ""
            echo "To create a beta release:"
            echo "1. Go to Actions → Release: Create Beta"
            echo "2. Click 'Run workflow'"
            echo "3. Select 'main' from the branch dropdown"
            exit 1
          fi
          echo "✓ Running on main branch"

  calculate-version:
    name: Calculate Version
    needs: check-branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Calculate beta version
        id: version
        run: |
          BASE=$(node -p "require('./frontend/package.json').version")
          DATE=$(date +%Y%m%d)

          git fetch --tags
          EXISTING=$(git tag -l "v${BASE}-beta.${DATE}.*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))

          VERSION="${BASE}-beta.${DATE}.${SEQ}"
          TAG="v${VERSION}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "### Beta Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** $TAG" >> $GITHUB_STEP_SUMMARY

  create-draft-release:
    name: Create Draft Release
    needs: calculate-version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Generate release notes
        run: |
          LAST_STABLE=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | grep -v beta | head -1)
          if [ -z "$LAST_STABLE" ]; then
            LAST_STABLE=$(git rev-list --max-parents=0 HEAD)
          fi

          COMMITS=$(git log "$LAST_STABLE"..HEAD --pretty=format:"- %s" --no-merges | head -30)
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" | sed 's/^- feat[:(]/- /' | sed 's/):/:/') || true
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" | sed 's/^- fix[:(]/- /' | sed 's/):/:/') || true

          cat > /tmp/release-notes.md << 'NOTESEOF'
          ## What's New in This Beta

          This is a pre-release build for testing new features before stable release.

          NOTESEOF

          sed -i 's/^          //' /tmp/release-notes.md

          if [ -n "$FEATURES" ]; then
            echo "### Features" >> /tmp/release-notes.md
            echo "$FEATURES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> /tmp/release-notes.md
            echo "$FIXES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          cat >> /tmp/release-notes.md << INSTALLEOF
          ---

          ### Installation Notes

          **macOS:** Signed and notarized. Drag to Applications and launch.

          **Windows:** Click "More info" → "Run anyway" if SmartScreen appears.

          **Linux:** Run \`chmod +x Eclosion-*.AppImage\` to make executable.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_STABLE}...${{ needs.calculate-version.outputs.tag }}
          INSTALLEOF

          sed -i 's/^          //' /tmp/release-notes.md

      - name: Clean up any existing draft with same tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"
          # Check if a draft release with this tag already exists (from a failed previous run)
          EXISTING_DRAFT=$(gh release view "$TAG" --json isDraft --jq '.isDraft' 2>/dev/null || echo "not_found")
          if [ "$EXISTING_DRAFT" = "true" ]; then
            echo "Found existing draft release $TAG from a previous failed run - deleting it"
            gh release delete "$TAG" --yes --cleanup-tag || true
          fi

      - name: Create draft pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.calculate-version.outputs.tag }} \
            --target main \
            --prerelease \
            --draft \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md

          echo "### Draft Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Created draft pre-release: ${{ needs.calculate-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # RUN RELEASE PIPELINE
  # ===========================================================================
  release-pipeline:
    name: Release Pipeline
    needs: [calculate-version, create-draft-release]
    uses: ./.github/workflows/release-pipeline.yml
    with:
      release_type: beta
      version: ${{ needs.calculate-version.outputs.version }}
      tag: ${{ needs.calculate-version.outputs.tag }}
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  # ===========================================================================
  # FINALIZE
  # ===========================================================================
  publish-release:
    name: Publish Release
    needs: [calculate-version, release-pipeline]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Mark release as non-draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh release edit ${{ needs.calculate-version.outputs.tag }} --draft=false

          echo "### Beta Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [${{ needs.calculate-version.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.calculate-version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:**" >> $GITHUB_STEP_SUMMARY
          echo "- [beta.eclosion.app](https://beta.eclosion.app)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: \`ghcr.io/${{ github.repository }}:${{ needs.calculate-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # Cleanup draft release if pipeline fails
  cleanup-on-failure:
    name: Cleanup Failed Release
    needs: [calculate-version, release-pipeline]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Delete draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"
          echo "Pipeline failed - cleaning up draft release $TAG"

          # Delete the release (this also deletes the tag)
          gh release delete "$TAG" --yes --cleanup-tag || true

          echo "### Release Failed" >> $GITHUB_STEP_SUMMARY
          echo "Draft release $TAG has been deleted." >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for failure details." >> $GITHUB_STEP_SUMMARY

# Create Beta Release
#
# Manually triggered workflow to create a beta pre-release from the develop branch.
# Beta versions use the format: v{current}-beta.{YYYYMMDD}.{sequence}
#
# Security gate: Runs full security scan suite (HIGH+ severity fails the release).
#
# This workflow creates a GitHub pre-release, which triggers:
# - deploy-cloudflare.yml → deploys to beta.eclosion.app
# - docker-publish.yml → builds Docker image with beta tag
# - build-desktop.yml → builds desktop apps for all platforms

name: "Release: Create Beta"

on:
  workflow_dispatch:
    branches:
      - develop

permissions:
  contents: write
  packages: write

jobs:
  # Validate we're on the develop branch (hardcoded check)
  check-branch:
    name: Check Branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Require develop branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/develop" ]; then
            echo "::error::This workflow can ONLY run from the develop branch."
            echo ""
            echo "Current branch: ${{ github.ref }}"
            echo "Required branch: refs/heads/develop"
            echo ""
            echo "To create a beta release:"
            echo "1. Go to Actions → Release: Create Beta"
            echo "2. Click 'Run workflow'"
            echo "3. Select 'develop' from the branch dropdown"
            exit 1
          fi
          echo "✓ Running on develop branch"

  # Run full security scan suite
  security:
    name: Security Scan
    needs: check-branch
    uses: ./.github/workflows/security.yml
    with:
      severity: high
      skip_dast: true  # Skip DAST for faster beta releases
    permissions:
      security-events: write
      contents: read

  # Create the beta release after security passes
  create-beta:
    name: Create Beta Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: security
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.base }}-beta.${{ steps.version.outputs.date }}.${{ steps.version.outputs.seq }}
    permissions:
      contents: write
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0  # Need full history for tags

      - name: Calculate beta version
        id: version
        run: |
          # Read current version from package.json
          BASE=$(node -p "require('./frontend/package.json').version")
          DATE=$(date +%Y%m%d)

          # Fetch all tags to ensure we have the latest
          git fetch --tags

          # Count existing tags for today's date
          EXISTING=$(git tag -l "v${BASE}-beta.${DATE}.*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))

          TAG="v${BASE}-beta.${DATE}.${SEQ}"

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "seq=$SEQ" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "### Beta Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Base version:** $BASE" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $DATE" >> $GITHUB_STEP_SUMMARY
          echo "- **Sequence:** $SEQ" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** $TAG" >> $GITHUB_STEP_SUMMARY

      - name: Generate release notes
        id: notes
        run: |
          # Find the last stable release tag (vX.Y.Z without -beta)
          LAST_STABLE=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | grep -v beta | head -1)

          if [ -z "$LAST_STABLE" ]; then
            echo "No previous stable release found, using first commit"
            LAST_STABLE=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating notes since $LAST_STABLE"

          # Get commits since last stable release
          COMMITS=$(git log "$LAST_STABLE"..HEAD --pretty=format:"- %s" --no-merges | head -30)

          # Categorize commits by conventional commit type
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" | sed 's/^- feat[:(]/- /' | sed 's/):/:/') || true
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" | sed 's/^- fix[:(]/- /' | sed 's/):/:/') || true

          # Build release notes file to avoid escaping issues
          cat > /tmp/release-notes.md << 'NOTESEOF'
          ## What's New in This Beta

          This is a pre-release build from the `develop` branch for testing new features before stable release.

          NOTESEOF

          if [ -n "$FEATURES" ]; then
            echo "### Features" >> /tmp/release-notes.md
            echo "$FEATURES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> /tmp/release-notes.md
            echo "$FIXES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          # Add installation notes
          cat >> /tmp/release-notes.md << INSTALLEOF
          ---

          ### Installation Notes

          **macOS users:** If you see "App is damaged" when opening, run this in Terminal:
          \`\`\`
          xattr -cr /Applications/Eclosion.app
          \`\`\`

          **Windows users:** Click "More info" → "Run anyway" if SmartScreen appears.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_STABLE}...${{ steps.version.outputs.tag }}
          INSTALLEOF

          # Remove leading whitespace from heredoc indentation
          sed -i 's/^          //' /tmp/release-notes.md

          echo "Generated release notes:"
          cat /tmp/release-notes.md

      - name: Create pre-release
        env:
          # Use PAT instead of GITHUB_TOKEN so the release triggers downstream workflows
          # (deploy-cloudflare.yml, docker-publish.yml)
          GH_TOKEN: ${{ secrets.CI_TRIGGER_PAT }}
        run: |
          gh release create ${{ steps.version.outputs.tag }} \
            --target develop \
            --prerelease \
            --title "${{ steps.version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md

          echo "### Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Pre-release [${{ steps.version.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}) created successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This will trigger:" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment to beta.eclosion.app" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image build with tag \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop app builds for macOS, Windows, and Linux" >> $GITHUB_STEP_SUMMARY

  # Build and publish Desktop app for beta release
  desktop-publish:
    name: Build Desktop App
    needs: create-beta
    uses: ./.github/workflows/build-desktop.yml
    with:
      version: ${{ needs.create-beta.outputs.version }}
      upload_to_release: true
    secrets:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

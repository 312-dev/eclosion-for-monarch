# Create Beta Release - Test
name: "Release: Create Beta"

on:
  workflow_dispatch:
    branches:
      - develop

permissions:
  contents: write
  packages: write

jobs:
  check-branch:
    name: Check Branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tag: v1.0.0-test
    steps:
      - name: Require develop branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/develop" ]; then
            echo "::error::Wrong branch"
            exit 1
          fi
          echo "âœ“ Running on develop branch"

  security:
    name: Security Scan
    needs: check-branch
    uses: ./.github/workflows/security.yml
    with:
      severity: high
      skip_dast: true
    permissions:
      security-events: write
      contents: read

  docker-build:
    name: Docker Build
    needs: [check-branch, security]
    uses: ./.github/workflows/docker-publish.yml
    with:
      tag: ${{ needs.check-branch.outputs.tag }}

  cloudflare-deploy:
    name: Cloudflare Deploy
    needs: [check-branch, security]
    uses: ./.github/workflows/deploy-cloudflare.yml
    with:
      environment: beta
      version: test-version
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

# Create Beta Release
#
# Manually triggered workflow to create a beta pre-release from the develop branch.
# Beta versions use the format: v{current}-beta.{YYYYMMDD}.{sequence}
#
# Release Flow (all steps must pass):
# 1. Security scan (HIGH+ severity fails the release)
# 2. Desktop builds (all platforms: macOS, Windows, Linux)
# 3. Docker image build and publish
# 4. Cloudflare Pages deployment
# 5. GitHub Release creation (only after all above succeed)
#
# If ANY step fails, the release is NOT created and nothing is published.
# macOS builds require paid GitHub Actions minutes - check billing if they fail.

name: "Release: Create Beta"

on:
  workflow_dispatch:
    branches:
      - develop

permissions:
  contents: write
  packages: write

jobs:
  # =========================================================================
  # Step 1: Validate branch
  # =========================================================================
  check-branch:
    name: Check Branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Require develop branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/develop" ]; then
            echo "::error::This workflow can ONLY run from the develop branch."
            echo ""
            echo "Current branch: ${{ github.ref }}"
            echo "Required branch: refs/heads/develop"
            echo ""
            echo "To create a beta release:"
            echo "1. Go to Actions → Release: Create Beta"
            echo "2. Click 'Run workflow'"
            echo "3. Select 'develop' from the branch dropdown"
            exit 1
          fi
          echo "✓ Running on develop branch"

  # =========================================================================
  # Step 2: Calculate version (needed by subsequent steps)
  # =========================================================================
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: check-branch
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Calculate beta version
        id: version
        run: |
          BASE=$(node -p "require('./frontend/package.json').version")
          DATE=$(date +%Y%m%d)

          git fetch --tags
          EXISTING=$(git tag -l "v${BASE}-beta.${DATE}.*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))

          TAG="v${BASE}-beta.${DATE}.${SEQ}"
          VERSION="${BASE}-beta.${DATE}.${SEQ}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "### Beta Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Step 3: Security scan
  # =========================================================================
  security:
    name: Security Scan
    needs: check-branch
    uses: ./.github/workflows/security.yml
    with:
      severity: high
      skip_dast: true
    permissions:
      security-events: write
      contents: read

  # =========================================================================
  # Step 4: Desktop builds (all platforms must pass)
  # =========================================================================
  desktop-build:
    name: Desktop Build
    needs: [calculate-version, security]
    uses: ./.github/workflows/build-desktop.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      upload_to_release: false  # Don't upload yet - release doesn't exist
    secrets:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  # =========================================================================
  # Step 5: Docker build
  # =========================================================================
  docker-build:
    name: Docker Build
    needs: [calculate-version, desktop-build]
    uses: ./.github/workflows/docker-publish.yml
    with:
      tag: ${{ needs.calculate-version.outputs.tag }}
    permissions:
      contents: read
      packages: write

  # =========================================================================
  # Step 6: Cloudflare deploy
  # =========================================================================
  cloudflare-deploy:
    name: Cloudflare Deploy
    needs: [calculate-version, docker-build]
    uses: ./.github/workflows/deploy-cloudflare.yml
    with:
      environment: beta
      version: ${{ needs.calculate-version.outputs.version }}
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # =========================================================================
  # Step 7: Create GitHub Release (only after all builds succeed)
  # =========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [calculate-version, desktop-build, docker-build, cloudflare-deploy]
    permissions:
      contents: write
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          LAST_STABLE=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | grep -v beta | head -1)

          if [ -z "$LAST_STABLE" ]; then
            echo "No previous stable release found, using first commit"
            LAST_STABLE=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating notes since $LAST_STABLE"

          COMMITS=$(git log "$LAST_STABLE"..HEAD --pretty=format:"- %s" --no-merges | head -30)
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" | sed 's/^- feat[:(]/- /' | sed 's/):/:/') || true
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" | sed 's/^- fix[:(]/- /' | sed 's/):/:/') || true

          cat > /tmp/release-notes.md << 'NOTESEOF'
          ## What's New in This Beta

          This is a pre-release build from the `develop` branch for testing new features before stable release.

          NOTESEOF

          if [ -n "$FEATURES" ]; then
            echo "### Features" >> /tmp/release-notes.md
            echo "$FEATURES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> /tmp/release-notes.md
            echo "$FIXES" >> /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
          fi

          cat >> /tmp/release-notes.md << INSTALLEOF
          ---

          ### Installation Notes

          **macOS users:** If you see "App is damaged" when opening, run this in Terminal:
          \`\`\`
          xattr -cr /Applications/Eclosion.app
          \`\`\`

          **Windows users:** Click "More info" → "Run anyway" if SmartScreen appears.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_STABLE}...${{ needs.calculate-version.outputs.tag }}
          INSTALLEOF

          sed -i 's/^          //' /tmp/release-notes.md

      - name: Create pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.calculate-version.outputs.tag }} \
            --target develop \
            --prerelease \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md

          echo "### Release Created" >> $GITHUB_STEP_SUMMARY
          echo "Pre-release [${{ needs.calculate-version.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.calculate-version.outputs.tag }}) created successfully." >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Step 8: Upload desktop artifacts to release
  # =========================================================================
  upload-artifacts:
    name: Upload Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [calculate-version, create-release]
    permissions:
      contents: write
    steps:
      - name: Download all desktop artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: eclosion-*
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "Artifacts to upload:"
          find artifacts -type f -exec ls -lh {} \; || echo "No artifacts found"

      - name: Combine checksums
        run: |
          if ls artifacts/checksums-*.txt 1> /dev/null 2>&1; then
            echo "Combining all checksum files into SHA256SUMS.txt..."
            cat artifacts/checksums-*.txt | sort -k2 | uniq > artifacts/SHA256SUMS.txt
            echo "Combined checksums:"
            cat artifacts/SHA256SUMS.txt
            rm -f artifacts/checksums-*.txt
          else
            echo "No checksum files found"
          fi

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${{ needs.calculate-version.outputs.tag }}"

          echo "Uploading desktop artifacts to release ${TAG}..."

          for file in artifacts/*; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              gh release upload "$TAG" "$file" --clobber || echo "Failed to upload $file"
            fi
          done

          echo "Upload complete!"

          echo "### Artifacts Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "Desktop artifacts uploaded to release." >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Summary
  # =========================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [calculate-version, security, desktop-build, docker-build, cloudflare-deploy, create-release, upload-artifacts]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Beta Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Desktop Build | ${{ needs.desktop-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Deploy | ${{ needs.cloudflare-deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Upload Artifacts | ${{ needs.upload-artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.calculate-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

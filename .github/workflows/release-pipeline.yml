# Release Pipeline
#
# Unified release orchestrator that handles the complete release process
# for both beta and production releases. Ensures strict stage gating:
#
#   Security â†’ Build All â†’ Validate â†’ Publish â†’ Finalize
#
# Nothing is published unless ALL builds succeed. Nothing is finalized
# unless ALL publishing steps succeed.
#
# Usage:
#   - Called by create-beta.yml for beta releases
#   - Called by create-stable.yml for production releases

name: Release Pipeline

on:
  workflow_call:
    inputs:
      release_type:
        description: 'Release type (beta or production)'
        required: true
        type: string
      version:
        description: 'Version number (e.g., 1.2.0 or 1.2.0-beta.20260108.1)'
        required: true
        type: string
      tag:
        description: 'Git tag (e.g., v1.2.0)'
        required: true
        type: string
      skip_security:
        description: 'Skip security scan (for re-runs after security already passed)'
        required: false
        type: boolean
        default: false
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true
      APPLE_CERTIFICATE:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_ID:
        required: false
      APPLE_APP_SPECIFIC_PASSWORD:
        required: false
      APPLE_TEAM_ID:
        required: false

# Note: This workflow inherits permissions from the calling workflow.
# Required permissions (must be granted by caller):
#   contents: write     - For checkout and release operations
#   packages: write     - For Docker image publishing
#   id-token: write     - For Sigstore keyless signing
#   security-events: write - For security scanning
#   deployments: write  - For Cloudflare deployment

jobs:
  # ===========================================================================
  # STAGE 1: SECURITY GATE
  # ===========================================================================
  security:
    name: "Stage 1: Security Scan"
    if: ${{ !inputs.skip_security }}
    uses: ./.github/workflows/security.yml
    with:
      severity: high
      skip_dast: true
    permissions:
      security-events: write
      contents: read

  # ===========================================================================
  # STAGE 2: BUILD ALL ARTIFACTS
  # All builds run in parallel but ALL must succeed to proceed
  # ===========================================================================

  # Build frontend once - shared by Docker and Cloudflare
  build-frontend:
    name: "Stage 2: Build Frontend"
    needs: [security]
    if: always() && (needs.security.result == 'success' || needs.security.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      artifact_name: frontend-dist-${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_DEMO_MODE: 'true'
          VITE_APP_VERSION: ${{ inputs.version }}
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: frontend/dist
          retention-days: 1

  # Generate screenshots for README
  generate-screenshots:
    name: "Stage 2: Generate Screenshots"
    needs: [security, build-frontend]
    if: always() && (needs.security.result == 'success' || needs.security.result == 'skipped') && needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download frontend artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: frontend/dist

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/screenshots-gen/package-lock.json

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install screenshot generator dependencies
        working-directory: scripts/screenshots-gen
        run: npm ci

      - name: Serve frontend and generate screenshots
        run: |
          # Start static file server in background
          cd frontend/dist
          npx serve -l 4173 &
          SERVER_PID=$!
          sleep 3

          # Generate screenshots
          cd ../../scripts/screenshots-gen
          npm run generate -- --url=http://localhost:4173

          # Cleanup
          kill $SERVER_PID || true

      - name: Upload screenshot artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: screenshots-${{ github.run_id }}
          path: scripts/screenshots-gen/output/*.png
          retention-days: 1

  # Build desktop apps for all platforms
  build-desktop:
    name: "Stage 2: Build Desktop Apps"
    needs: [security]
    if: always() && (needs.security.result == 'success' || needs.security.result == 'skipped')
    uses: ./.github/workflows/build-desktop.yml
    with:
      version: ${{ inputs.version }}
      upload_to_release: false  # We'll upload after validation
    secrets:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  # Build Docker image (push with SHA tag, not version tag yet)
  build-docker:
    name: "Stage 2: Build Docker Image"
    needs: [security, build-frontend]
    if: always() && (needs.security.result == 'success' || needs.security.result == 'skipped') && needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_name: ${{ steps.image.outputs.name }}
      image_tag: ${{ steps.image.outputs.tag }}
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for Sigstore keyless signing
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download frontend artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: frontend/dist

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image name
        id: image
        run: |
          # GHCR requires lowercase repository names
          IMAGE=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "name=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE:sha-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push with SHA tag
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        env:
          BUILDKIT_PROGRESS: plain
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.image.outputs.tag }}
          build-args: |
            BUILD_TIME=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
            VERSION=${{ inputs.version }}
            RELEASE_CHANNEL=${{ inputs.release_type }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Sign the container image with Sigstore cosign (keyless)
      - name: Install cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.0

      - name: Sign container image
        run: |
          cosign sign --yes ${{ steps.image.outputs.tag }}@${{ steps.build.outputs.digest }}
          echo "## Container Signature" >> $GITHUB_STEP_SUMMARY
          echo "Image signed with Sigstore (keyless)" >> $GITHUB_STEP_SUMMARY
          echo "Verify with: \`cosign verify ${{ steps.image.outputs.tag }}@${{ steps.build.outputs.digest }} --certificate-oidc-issuer https://token.actions.githubusercontent.com --certificate-identity-regexp https://github.com/${{ github.repository }}/\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # STAGE 3: VALIDATION GATE
  # Ensures ALL builds passed before any publishing
  # ===========================================================================
  validate-builds:
    name: "Stage 3: Validate All Builds"
    needs: [build-frontend, build-desktop, build-docker, generate-screenshots]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check build results
        run: |
          echo "## Build Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Desktop | ${{ needs.build-desktop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Screenshots | ${{ needs.generate-screenshots.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail if any build failed
          if [[ "${{ needs.build-frontend.result }}" != "success" ]]; then
            echo "::error::Frontend build failed"
            exit 1
          fi
          if [[ "${{ needs.build-desktop.result }}" != "success" ]]; then
            echo "::error::Desktop build failed"
            exit 1
          fi
          if [[ "${{ needs.build-docker.result }}" != "success" ]]; then
            echo "::error::Docker build failed"
            exit 1
          fi
          if [[ "${{ needs.generate-screenshots.result }}" != "success" ]]; then
            echo "::error::Screenshot generation failed"
            exit 1
          fi

          echo "âœ… All builds passed validation" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # STAGE 4: PUBLISH
  # Only runs after ALL builds are validated
  # ===========================================================================

  # Tag Docker image with version (promotes SHA tag to version tag)
  publish-docker:
    name: "Stage 4: Publish Docker"
    needs: [validate-builds, build-docker]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      packages: write
    steps:
      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag image with version
        run: |
          IMAGE="${{ needs.build-docker.outputs.image_name }}"
          SHA_TAG="${{ needs.build-docker.outputs.image_tag }}"
          VERSION="${{ inputs.version }}"
          # Strip 'v' prefix if present
          VERSION="${VERSION#v}"

          echo "Promoting $SHA_TAG to $IMAGE:$VERSION"

          # Pull the SHA-tagged image
          docker pull "$SHA_TAG"

          # Tag with version
          docker tag "$SHA_TAG" "$IMAGE:$VERSION"
          docker push "$IMAGE:$VERSION"

          # For stable releases, also tag with major.minor
          if [[ "$VERSION" != *-* ]]; then
            MAJOR_MINOR=$(echo "$VERSION" | grep -oE '^[0-9]+\.[0-9]+')
            if [[ -n "$MAJOR_MINOR" ]]; then
              docker tag "$SHA_TAG" "$IMAGE:$MAJOR_MINOR"
              docker push "$IMAGE:$MAJOR_MINOR"
              echo "Also tagged as $IMAGE:$MAJOR_MINOR"
            fi
          fi

          echo "## Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "- \`$IMAGE:$VERSION\`" >> $GITHUB_STEP_SUMMARY

  # Upload desktop artifacts to GitHub release
  # NOTE: Package visibility must be set to public manually once via GitHub UI:
  # Repository > Packages > Package Settings > Danger Zone > Change visibility
  publish-desktop:
    name: "Stage 4: Publish Desktop"
    needs: [validate-builds]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      id-token: write  # Required for Sigstore keyless signing
    steps:
      - name: Download all desktop artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: eclosion-*
          path: artifacts
          merge-multiple: true

      - name: Download screenshot artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: screenshots-${{ github.run_id }}
          path: screenshots

      - name: Combine checksums
        run: |
          echo "Combining checksum files..."
          cat artifacts/checksums-*.txt 2>/dev/null | sort -k2 | uniq > artifacts/SHA256SUMS.txt || true
          rm -f artifacts/checksums-*.txt
          echo "Combined checksums:"
          cat artifacts/SHA256SUMS.txt

      # Sign release artifacts with Sigstore cosign (keyless)
      - name: Install cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.0

      - name: Sign release artifacts
        run: |
          echo "Signing release artifacts with Sigstore..."
          cd artifacts

          # Sign each binary artifact (skip metadata files)
          for file in *.dmg *.zip *.exe *.AppImage *.deb *.rpm; do
            if [ -f "$file" ]; then
              echo "Signing: $file"
              cosign sign-blob --yes "$file" --output-signature "${file}.sig" --output-certificate "${file}.pem"
            fi
          done

          # Sign the checksums file
          if [ -f "SHA256SUMS.txt" ]; then
            echo "Signing: SHA256SUMS.txt"
            cosign sign-blob --yes "SHA256SUMS.txt" --output-signature "SHA256SUMS.txt.sig" --output-certificate "SHA256SUMS.txt.pem"
          fi

          echo "## Release Artifact Signatures" >> $GITHUB_STEP_SUMMARY
          echo "All artifacts signed with Sigstore (keyless)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verify with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-blob --signature <file>.sig --certificate <file>.pem \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp 'https://github.com/${{ github.repository }}/' <file>" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          TAG="${{ inputs.tag }}"
          echo "Uploading desktop artifacts to release $TAG..."

          for file in artifacts/*; do
            if [ -f "$file" ]; then
              echo "Uploading: $(basename $file)"
              gh release upload "$TAG" "$file" --clobber || echo "::warning::Failed to upload $file"
            fi
          done

          echo "Uploading screenshots to release $TAG..."
          for file in screenshots/*.png; do
            if [ -f "$file" ]; then
              echo "Uploading: $(basename $file)"
              gh release upload "$TAG" "$file" --clobber || echo "::warning::Failed to upload $file"
            fi
          done

          echo "## Desktop Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "Uploaded to release $TAG" >> $GITHUB_STEP_SUMMARY
          echo "## Screenshots Published" >> $GITHUB_STEP_SUMMARY
          echo "Uploaded screenshots to release $TAG" >> $GITHUB_STEP_SUMMARY

  # Deploy to Cloudflare Pages
  deploy-cloudflare:
    name: "Stage 4: Deploy Cloudflare"
    needs: [validate-builds, build-frontend]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.release_type }}
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download frontend artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: frontend/dist

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docusaurus/package-lock.json

      - name: Build Docusaurus
        working-directory: docusaurus
        env:
          ECLOSION_BETA: ${{ inputs.release_type == 'beta' && 'true' || '' }}
          ECLOSION_VERSION: ${{ inputs.version }}
        run: |
          npm ci
          npm run build

      - name: Merge builds
        run: |
          # Save React app's key files
          cp frontend/dist/index.html /tmp/react-index.html
          cp frontend/dist/_redirects /tmp/react-redirects
          cp frontend/dist/404.html /tmp/react-404.html

          # Copy Docusaurus build
          cp -r docusaurus/build/* frontend/dist/

          # Restore React app files
          cp /tmp/react-index.html frontend/dist/index.html
          cp /tmp/react-redirects frontend/dist/_redirects
          cp /tmp/react-404.html frontend/dist/404.html

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy frontend/dist --project-name=eclosion --branch=${{ inputs.release_type == 'production' && 'main' || 'beta' }}

      - name: Summary
        run: |
          echo "## Cloudflare Deployment" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.release_type }}" == "production" ]]; then
            echo "Deployed to [eclosion.app](https://eclosion.app)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Deployed to [beta.eclosion.app](https://beta.eclosion.app)" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # STAGE 5: FINALIZE
  # Only runs after ALL publishing steps succeed
  # ===========================================================================
  finalize:
    name: "Stage 5: Finalize Release"
    needs: [publish-docker, publish-desktop, deploy-cloudflare]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Create docs version (production only)
        if: inputs.release_type == 'production'
        run: |
          cd docusaurus
          npm ci
          npm run version -- "${{ inputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json versioned_docs versioned_sidebars
          git diff --staged --quiet && echo "No version changes" && exit 0
          git commit -m "docs: create version ${{ inputs.version }}"
          git push

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Desktop apps (macOS, Windows, Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Web deployment" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.release_type }}" == "production" ]]; then
            echo "- âœ… Documentation version" >> $GITHUB_STEP_SUMMARY
          fi

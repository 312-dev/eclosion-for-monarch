# Require develop branch for PRs to main
# Enforces Git Flow: feature branches → develop → main
#
# This ensures all changes are tested on beta.eclosion.app before release

name: "Check: Require Develop"

on:
  pull_request:
    branches: [main]
  # Allow manual trigger for PRs created by GITHUB_TOKEN (e.g., release-please)
  workflow_dispatch:
    inputs:
      pr_branch:
        description: 'PR head branch to check'
        required: true
        type: string

jobs:
  check-source:
    name: Require develop branch
    runs-on: ubuntu-latest
    steps:
      - name: Check source branch
        run: |
          # Use input for workflow_dispatch, github.head_ref for pull_request
          HEAD_REF="${{ inputs.pr_branch || github.head_ref }}"

          # Allow automated branches from release-please and productboard-sync
          if [[ "$HEAD_REF" =~ ^release-please-- ]]; then
            echo "✅ Release-please branch - automated release PR"
            exit 0
          fi

          if [[ "$HEAD_REF" =~ ^chore/productboard-sync- ]]; then
            echo "✅ ProductBoard sync branch - automated data update"
            exit 0
          fi

          if [ "$HEAD_REF" != "develop" ]; then
            echo "::error::PRs to main must come from the develop branch."
            echo ""
            echo "This repository uses Git Flow:"
            echo "  1. Create feature branches from develop"
            echo "  2. PR your changes to develop"
            echo "  3. Test on beta.eclosion.app"
            echo "  4. Maintainers merge develop → main for releases"
            echo ""
            echo "Please close this PR and create a new one targeting develop instead."
            exit 1
          fi
          echo "✅ PR is from develop branch"

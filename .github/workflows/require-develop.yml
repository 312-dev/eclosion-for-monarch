# Require develop branch for PRs to main
# Enforces Git Flow: feature branches → develop → main
#
# This ensures all changes are tested on beta.eclosion.app before release

name: "Check: Require Develop"

on:
  pull_request:
    branches: [main]
  # Allow manual trigger for PRs created by GITHUB_TOKEN (e.g., release-please)
  workflow_dispatch:
    inputs:
      pr_branch:
        description: 'PR head branch to check'
        required: true
        type: string

jobs:
  check-source:
    name: Require develop branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Get head commit for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: get-sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/${{ inputs.pr_branch }} --jq '.object.sha' 2>/dev/null || echo "")
          if [ -z "$SHA" ]; then
            echo "::error::Failed to get SHA for branch ${{ inputs.pr_branch }}"
            exit 1
          fi
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Head commit: $SHA"

      - name: Check source branch
        id: check
        run: |
          # Use input for workflow_dispatch, github.head_ref for pull_request
          HEAD_REF="${{ inputs.pr_branch || github.head_ref }}"

          # Allow automated branches from productboard-sync and contributors-sync
          if [[ "$HEAD_REF" =~ ^update/productboard-sync- ]]; then
            echo "✅ ProductBoard sync branch - automated data update"
            echo "result=success" >> $GITHUB_OUTPUT
            echo "description=ProductBoard sync branch - automated data update" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$HEAD_REF" =~ ^update/contributors- ]]; then
            echo "✅ Contributors sync branch - automated data update"
            echo "result=success" >> $GITHUB_OUTPUT
            echo "description=Contributors sync branch - automated data update" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$HEAD_REF" != "develop" ]; then
            echo "::error::PRs to main must come from the develop branch."
            echo ""
            echo "This repository uses Git Flow:"
            echo "  1. Create feature branches from develop"
            echo "  2. PR your changes to develop"
            echo "  3. Test on beta.eclosion.app"
            echo "  4. Maintainers merge develop → main for releases"
            echo ""
            echo "Please close this PR and create a new one targeting develop instead."
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "description=PRs to main must come from develop branch" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "✅ PR is from develop branch"
          echo "result=success" >> $GITHUB_OUTPUT
          echo "description=PR is from develop branch" >> $GITHUB_OUTPUT

      # For workflow_dispatch, post status to the PR's head commit
      - name: Post commit status
        if: github.event_name == 'workflow_dispatch' && steps.get-sha.outputs.sha && always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ steps.get-sha.outputs.sha }} \
            -f state="${{ steps.check.outputs.result || 'success' }}" \
            -f context="Require develop branch" \
            -f description="${{ steps.check.outputs.description || 'Branch check passed' }}"
          echo "Posted status to commit ${{ steps.get-sha.outputs.sha }}"

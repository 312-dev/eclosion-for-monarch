name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.release.outputs.pr && fromJSON(steps.release.outputs.pr).number || '' }}
      pr_head_branch: ${{ steps.release.outputs.pr && fromJSON(steps.release.outputs.pr).headBranchName || '' }}
      pr_created: ${{ steps.release.outputs.pr != '' }}
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Release created
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "Release created: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

  generate-summary:
    needs: release-please
    if: needs.release-please.outputs.pr_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.release-please.outputs.pr_head_branch }}
          fetch-depth: 0

      - name: Extract changelog additions
        id: extract
        run: |
          # Extract content between first ## [version] header and second ## [version] or end
          # This captures all the new changelog entries
          CHANGELOG_CONTENT=$(awk '
            /^## \[.*\]/ {
              if (found) exit
              found = 1
              next
            }
            found { print }
          ' CHANGELOG.md)

          # Use delimiter for multiline output
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI summary
        id: summary
        env:
          GH_TOKEN: ${{ secrets.MODELS_TOKEN }}
        run: |
          PROMPT="Summarize this changelog for regular users. If there are meaningful frontend/UI changes users would notice, describe them with bullet points if needed. But if it is mostly technical stuff (backend, CI, security, refactoring, deps, Docker), keep it to ONE short playful sentence like 'Tidied up behind the scenes' or 'Developer housekeeping' - no details needed. No quotes or apostrophes in your response.

          Changes:
          ${{ steps.extract.outputs.changelog_content }}

          Summary (1-2 sentences):"

          RESPONSE=$(curl -s https://models.inference.ai.azure.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}],
              \"max_tokens\": 150,
              \"temperature\": 0.7
            }")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$SUMMARY" ]; then
            echo "Failed to generate summary"
            echo "API Response: $RESPONSE"
            echo "summary=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Escape for shell and output
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Insert summary into CHANGELOG
        if: steps.summary.outputs.summary != ''
        env:
          SUMMARY: ${{ steps.summary.outputs.summary }}
        run: |
          # Insert blockquote summary after first ## [version] line
          awk -v summary="> $SUMMARY" '
            /^## \[.*\] - [0-9]/ && !done {
              print
              print ""
              print summary
              done = 1
              next
            }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "Inserted summary into CHANGELOG.md"

      - name: Commit and push summary
        id: commit
        if: steps.summary.outputs.summary != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: add AI-generated changelog summary"
          git push
          echo "pushed=true" >> $GITHUB_OUTPUT

      # Trigger CI/Security workflows since GITHUB_TOKEN pushes don't trigger them
      - name: Trigger required workflows
        if: steps.commit.outputs.pushed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ needs.release-please.outputs.pr_head_branch }}"
          gh workflow run ci.yml --ref "$BRANCH"
          gh workflow run security.yml --ref "$BRANCH"
          echo "Triggered CI and Security workflows on $BRANCH"

  auto-merge:
    needs: [release-please, generate-summary]
    if: always() && needs.release-please.outputs.pr_created == 'true' && needs.release-please.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge release PR
        run: gh pr merge ${{ needs.release-please.outputs.pr_number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # Create Docusaurus version snapshot when a release is created
  create-docs-version:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docusaurus/package-lock.json

      - name: Install dependencies
        working-directory: docusaurus
        run: npm ci

      - name: Create docs version
        working-directory: docusaurus
        run: npm run version -- "${{ needs.release-please.outputs.version }}"

      - name: Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docusaurus/versions.json docusaurus/versioned_docs docusaurus/versioned_sidebars
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "docs: create version ${{ needs.release-please.outputs.version }}"
          git push

  # Build and publish Docker image when a release is created
  docker-publish:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    uses: ./.github/workflows/docker-publish.yml
    with:
      tag: ${{ needs.release-please.outputs.tag_name }}
    permissions:
      contents: read
      packages: write

  # Deploy demo site to GitHub Pages when a release is created
  deploy-demo:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    uses: ./.github/workflows/deploy-demo.yml
    permissions:
      contents: read
      pages: write
      id-token: write

# Production Release
#
# Triggered on push to main branch. Uses release-please to manage releases.
#
# Two modes:
#   1. PR Mode: When release-please creates/updates a release PR
#      - Generates AI summary for changelog
#      - Generates documentation
#      - Triggers CI checks
#      - Auto-merges if no doc changes
#
#   2. Release Mode: When release-please creates a release
#      - Runs the unified release pipeline (security â†’ build â†’ publish)
#      - Strict gating: nothing published unless ALL builds succeed

name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: write
  security-events: write
  deployments: write

jobs:
  # ===========================================================================
  # RELEASE-PLEASE
  # ===========================================================================
  release-please:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      pr_number: ${{ steps.release.outputs.pr && fromJSON(steps.release.outputs.pr).number || '' }}
      pr_head_branch: ${{ steps.release.outputs.pr && fromJSON(steps.release.outputs.pr).headBranchName || '' }}
      pr_created: ${{ steps.release.outputs.pr != '' }}
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Release created
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "Release created: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

  # ===========================================================================
  # PR MODE: Manage Release PRs
  # ===========================================================================
  generate-summary:
    needs: release-please
    if: needs.release-please.outputs.pr_created == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.pr_head_branch }}
          fetch-depth: 0

      - name: Extract changelog additions
        id: extract
        run: |
          CHANGELOG_CONTENT=$(awk '
            /^## \[.*\]/ {
              if (found) exit
              found = 1
              next
            }
            found { print }
          ' CHANGELOG.md)

          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI summary
        id: summary
        env:
          GH_TOKEN: ${{ secrets.MODELS_TOKEN }}
        run: |
          PROMPT="Summarize this changelog for regular users. If there are meaningful frontend/UI changes users would notice, describe them with bullet points if needed. But if it is mostly technical stuff (backend, CI, security, refactoring, deps, Docker), keep it to ONE short playful sentence like 'Tidied up behind the scenes' or 'Developer housekeeping' - no details needed. No quotes or apostrophes in your response.

          Changes:
          ${{ steps.extract.outputs.changelog_content }}

          Summary (1-2 sentences):"

          RESPONSE=$(curl -s https://models.inference.ai.azure.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}],
              \"max_tokens\": 150,
              \"temperature\": 0.7
            }")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$SUMMARY" ]; then
            echo "Failed to generate summary"
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // .error // "Unknown error"')
            echo "API Error: $ERROR"
            echo "summary=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Insert summary into CHANGELOG
        if: steps.summary.outputs.summary != ''
        env:
          SUMMARY: ${{ steps.summary.outputs.summary }}
        run: |
          awk -v summary="> $SUMMARY" '
            /^## \[.*\] - [0-9]/ && !done {
              print
              print ""
              print summary
              done = 1
              next
            }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

      - name: Commit and push summary
        if: steps.summary.outputs.summary != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: add AI-generated changelog summary"
          git push

  generate-docs:
    needs: [release-please, generate-summary]
    if: always() && needs.release-please.outputs.pr_created == 'true' && needs.release-please.result == 'success'
    uses: ./.github/workflows/generate-docs.yml
    with:
      version: ${{ needs.release-please.outputs.version }}
      branch: ${{ needs.release-please.outputs.pr_head_branch }}
    secrets: inherit

  trigger-checks:
    needs: [release-please, generate-summary, generate-docs]
    if: always() && needs.release-please.outputs.pr_created == 'true' && needs.release-please.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Trigger required workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          BRANCH="${{ needs.release-please.outputs.pr_head_branch }}"
          HEAD_SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/$BRANCH --jq '.object.sha')
          echo "Triggering workflows for $BRANCH at SHA $HEAD_SHA"

          gh workflow run ci.yml --ref "$BRANCH" -f head_sha="$HEAD_SHA"
          gh workflow run security.yml --ref "$BRANCH" -f head_sha="$HEAD_SHA"
          gh workflow run require-develop.yml --ref main -f pr_branch="$BRANCH"

  auto-merge:
    needs: [release-please, generate-docs, trigger-checks]
    if: always() && needs.release-please.outputs.pr_created == 'true' && needs.release-please.result == 'success' && needs.generate-docs.result == 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Auto-merge release PR
        run: gh pr merge ${{ needs.release-please.outputs.pr_number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  docs-review-reminder:
    needs: [release-please, generate-docs]
    if: needs.generate-docs.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Add review reminder comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh pr comment ${{ needs.release-please.outputs.pr_number }} --body "ðŸ“š **Documentation Updated**

          This PR includes auto-generated user guide updates. Please review the changes in:
          - \`frontend/src/docs/guide/\` (bundled in app)
          - \`docusaurus/guide/\` (public docs site)

          Once reviewed, manually merge this PR."

  # ===========================================================================
  # RELEASE MODE: Run Release Pipeline
  # ===========================================================================
  release-pipeline:
    name: Release Pipeline
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    uses: ./.github/workflows/release-pipeline.yml
    with:
      release_type: production
      version: ${{ needs.release-please.outputs.version }}
      tag: ${{ needs.release-please.outputs.tag_name }}
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

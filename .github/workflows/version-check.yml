# Version Consistency Check
#
# Validates that all version files are in sync.
# SOURCE OF TRUTH: frontend/package.json
#
# Runs on all PRs to prevent version drift.

name: Version Check

on:
  pull_request:
    paths:
      - 'frontend/package.json'
      - 'desktop/package.json'
      - 'docusaurus/package.json'
      - 'pyproject.toml'
      - '.release-please-manifest.json'

permissions: read-all

jobs:
  check-versions:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check all versions match
        run: |
          echo "Checking version consistency..."
          echo ""

          # Source of truth
          FRONTEND=$(jq -r '.version' frontend/package.json)
          echo "frontend/package.json (source of truth): $FRONTEND"

          # Other version files
          DESKTOP=$(jq -r '.version' desktop/package.json)
          DOCUSAURUS=$(jq -r '.version' docusaurus/package.json)
          PYPROJECT=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          MANIFEST=$(jq -r '.[]' .release-please-manifest.json 2>/dev/null || echo "missing")

          echo "desktop/package.json: $DESKTOP"
          echo "docusaurus/package.json: $DOCUSAURUS"
          echo "pyproject.toml: $PYPROJECT"
          echo ".release-please-manifest.json: $MANIFEST"
          echo ""

          # Check for mismatches
          ERRORS=0

          if [ "$DESKTOP" != "$FRONTEND" ]; then
            echo "::error::desktop/package.json version ($DESKTOP) does not match frontend ($FRONTEND)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$DOCUSAURUS" != "$FRONTEND" ]; then
            echo "::error::docusaurus/package.json version ($DOCUSAURUS) does not match frontend ($FRONTEND)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$PYPROJECT" != "$FRONTEND" ]; then
            echo "::error::pyproject.toml version ($PYPROJECT) does not match frontend ($FRONTEND)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$MANIFEST" != "$FRONTEND" ] && [ "$MANIFEST" != "missing" ]; then
            echo "::error::.release-please-manifest.json version ($MANIFEST) does not match frontend ($FRONTEND)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "::error::Found $ERRORS version mismatch(es). All version files must match frontend/package.json."
            echo ""
            echo "To fix, update all files to version $FRONTEND or use the release workflows."
            exit 1
          fi

          echo "âœ… All versions match: $FRONTEND"
